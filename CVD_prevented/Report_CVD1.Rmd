---
title: "Report for the Markov model (cohort state-transition model)"
header-includes:
   - \usepackage{amsmath}
   - \usepackage{booktabs}
   - \usepackage{fancyhdr}
   - \pagestyle{fancy}
   - \usepackage{array}
   - \usepackage{multirow}
   # - \usepackage{afterpage}
   - \usepackage{rotating}
output: pdf_document
# classoption: landscape
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(knitr)
library(xtable)
library(darthtools)
library(ggplot2)
```

# Data and parameters
```{r, results='asis', message=FALSE}
library(readr)
rate_data <- read_csv("../data/ghdx_data.csv")
print(xtable(data.frame(rate_data),digits=c(0,0,0,6,6,6),
      caption = "Data from Global Health Data Exchange"),
      caption.placement="top")
```

```{r, results='asis', message=FALSE}
library(readr)
noStrategy_data <- read_csv("../data/Normal_data.csv")
print(xtable(data.frame(noStrategy_data),digits=c(0,0,0,0),
      caption = "Distribution of the population"),
      caption.placement="top")
```

```{r, results='asis', message=FALSE}
population_data <- readr::read_csv("../data/Normal3Stra_data.csv")
population_data <- data.frame(population_data)
print(xtable(data.frame(population_data),digits=c(0,0,0,0,0,0,0),
      caption = "Distribution of the population under different strategies"),caption.placement="top")
```

\clearpage
```{r}
## General setup
source("../function/transform_func.R")
n_t <- 10   # time horizon, number of cycles
# S1: live; S2: cvd; S3: cvdth; S4: oth_death
v_names_states <- c("S1", "S2", "S3", "S4")  
n_states    <- length(v_names_states)   # number of health states 
v_names_str <- c("Strategy0","Strategy1", "Strategy2", "Strategy3") # store the strategy names
n_str       <- length(v_names_str)      # number of strategies

# Health utilities
out_cvd_free <-	1   # utility when being S1
out_cvd <- 0.9   # utility when being S2
out_dth <-	0   # utility when being S3 and S4 together
out_trans_to_cvd <-	-0.038    # TODO

uti_values <- c(out_cvd_free, out_cvd, out_dth, out_dth)

HR_cvdhistory_cvd <-	1.37
HR_cvdhistory_cvdth <- 3.12
HR_high_live_cvdth <-	1.17

p_live_oth_death <- rate_to_prob(r=rate_data$death_nonCVD,t = 1)
p_live_cvd <- rate_to_prob(r=rate_data$incidence, t=1)
p_live_cvdth <- rate_to_prob(r=rate_data$death_CVD, t=1)
# transition probability from S2 to S3
p_ccvd_acvd <- rate_to_prob(rate_data$incidence*HR_cvdhistory_cvd, t=1)
p_ccvd_cvdth <- rate_to_prob(rate_data$death_CVD*HR_cvdhistory_cvdth,t=1)
set.seed(100)
p_acvd_cvdth <- rep(runif(1,min=0.02,max=0.1),length=length(p_live_cvd))
```

### Component 1: A transition probability matrix $P_t$
$$
P_t=
\begin{Bmatrix}
p_{[1,1,t]} & p_{[1,2,t]} & p_{[1,3,t]} & p_{[1,4,t]} \\
p_{[2,1,t]} & p_{[2,2,t]} & p_{[2,3,t]} & p_{[2,4,t]} \\
p_{[3,1,t]} & p_{[3,2,t]} & p_{[3,3,t]} & p_{[3,4,t]} \\
p_{[4,1,t]} & p_{[4,2,t]} & p_{[4,3,t]} & p_{[4,4,t]}\\
\end{Bmatrix}
$$
Thus, 

$P4 = 1-P1-P2-P3$

$P1 = p\_live\_cvd*(1-p\_acvd\_cvdth)$

$P2 = p\_live\_cvdth + p\_live\_cvd*p\_acvd\_cvdth$ 

$P3 = p\_live\_oth\_death$

$P6= 1-(p\_ccvd\_cvdth+p\_ccvd\_acvd*p\_acvd\_cvdth)-p\_live\_oth\_death$

$P5= p\_ccvd\_cvdth+p\_ccvd\_acvd*p\_acvd\_cvdth$



\newpage
```{r echo=FALSE}
HR_l_stg1	<- 0.63
HR_m_stg1	<- 1.56
HR_h_stg1	<- 1.6

HR_l_stg2	<- 0.43
HR_m_stg2	<- 0.97
HR_h_stg2	<- 2.06

HR_l_stg3	<- 0.45
HR_m_stg3	<- 1.09
HR_h_stg3	<- 2.11
# lifestyle intervention for medium risk and above
HR_smk_cvd	<-	0.85
HR_smk_cvdth	<-	0.72
HR_salt_cvd	<-	0.81
HR_salt_cvdth	<-	0.66
HR_wtc_cvd	<-	0.93
HR_wtc_dth	<-	0.93
# treatment intervention for high risk (additional)
HR_hpt_lip_cvd	<-	0.7
HR_hpt_lip_cvdth <-	0.82
```

\begin{center}
\begin{table}
\caption{Incidence rate}
\begin{tabular}{cccc} 
\hline
Item & & CVD incidence(HR) & CVD cause-specific mortality (HR)  \\
\hline
\multirow{3}{6em}{Strategy 1}& {Low risk} & `r HR_l_stg1` & 1   \\
& {Medium risk}& `r HR_m_stg1`  &  1\\
& {High risk}& `r HR_h_stg1`  &  1.7 \\
\hline
\multirow{3}{6em}{Strategy 2}& {Low risk}& `r HR_l_stg2`  & 1 \\
& {Medium risk}  & `r HR_m_stg2` &  1\\
& {High risk}  &`r HR_h_stg2`  &  1.7\\
\hline
\multirow{3}{6em}{Strategy 3}& {Low risk}  & `r HR_l_stg3` & 1 \\
& {Medium risk}  & `r HR_m_stg3` &  1\\
& {High risk}  & `r HR_h_stg3` &  1.7\\
\hline
\multirow{3}{6em}{Intervention}& {Weight control}  & `r HR_wtc_cvd` &  `r HR_wtc_dth`\\
& {Smoke cession}  & `r HR_smk_cvd` & `r HR_smk_cvdth` \\
& {Salt reduction}  & `r HR_salt_cvd` & `r HR_salt_cvdth` \\
\hline
Medication & Statin and antihypertensive & `r HR_hpt_lip_cvd` &  `r HR_hpt_lip_cvdth` \\
\hline
\end{tabular}
\end{table}
\end{center}

# Strategy 1 (a male 40-45)

```{r}
p_live_cvd_l <- ProbFactor(p_live_cvd,HR_l_stg1)
p_live_cvd_m <- ProbFactor(p_live_cvd,HR_m_stg1*
                             HR_smk_cvd*HR_salt_cvd*HR_wtc_cvd)  # lifestyle intervention
p_live_cvd_h <- ProbFactor(p_live_cvd,HR_h_stg1*
                             HR_smk_cvdth*HR_salt_cvdth*HR_wtc_dth*    # lifestyle intervention
                             HR_hpt_lip_cvdth)   # treatment intervention 

# transition probability to death
p_live_cvdth_l <- ProbFactor(p_live_cvdth,1)    # equal
p_live_cvdth_m <- ProbFactor(p_live_cvdth,1*
                               HR_smk_cvd*HR_salt_cvd*HR_wtc_cvd)  # lifestyle intervention 
p_live_cvdth_h <- ProbFactor(p_live_cvdth,1.7*
                               HR_smk_cvdth*HR_salt_cvdth*HR_wtc_dth* # lifestyle intervention
                               HR_hpt_lip_cvdth) # treatment intervention 
# again get cvd 
p_ccvd_acvd <- ProbFactor(p_live_cvd,HR_cvdhistory_cvd) 
p_ccvd_cvdth <- ProbFactor(p_live_cvdth,HR_cvdhistory_cvdth)
```


Thus, we take the example of individuals in the low level

$\underline{P4} = 1-P1-P2-P3$

$\underline{P1} = p\_live\_cvd\_l*(1-p\_acvd\_cvdth)$

$\underline{P2} = p\_live\_cvdth\_l + p\_live\_cvd\_l*p\_acvd\_cvdth$ 

$P3 = p\_live\_oth\_death$  

$P6= 1-(p\_ccvd\_cvdth+p\_ccvd\_acvd*p\_acvd\_cvdth)-p\_live\_oth\_death$

$P5= p\_ccvd\_cvdth+p\_ccvd\_acvd*p\_acvd\_cvdth$

\textcolor{red}{We say that the screening strategy will have an influence on the first line of the transition matrix.}

```{r}
###################### Construct state-transition models for Strategy1 #####################
#### Create transition arrays ####
a_P <- array(0, dim      = c(n_states, n_states, 10),
                dimnames = list(v_names_states, v_names_states, 1:10))
## From S1, S2, S3, S4
a_P["S1", "S1", 1:5]   <- 1-(p_live_cvd_l[1]*(1-p_acvd_cvdth[1]) +
                               p_live_cvdth_l[1]*p_live_cvd_l[1]*p_acvd_cvdth[1] +
                               p_live_oth_death[1])

a_P["S1", "S2", 1:5]  <- p_live_cvd_l[1]*(1-p_acvd_cvdth[1])
a_P["S1", "S3", 1:5]   <- p_live_cvdth_l[1]*p_live_cvd_l[1]*p_acvd_cvdth[1]
a_P["S1", "S4", 1:5]   <- p_live_oth_death[1]
a_P["S2", "S1", 1:5] <- 0
a_P["S2", "S2", 1:5] <- 1-p_live_oth_death[1]-
  (p_ccvd_cvdth[1]+p_ccvd_acvd[1]*p_acvd_cvdth[1])
a_P["S2", "S3", 1:5] <- p_ccvd_cvdth[1]+
  p_ccvd_acvd[1]*p_acvd_cvdth[1]
a_P["S2", "S4", 1:5] <- p_live_oth_death[1]
a_P["S3", "S3", 1:5] <- 1
a_P["S4", "S4", 1:5] <- 1

## From S1, S2, S3, S4
a_P["S1", "S1", 6:10] <-  1-(p_live_cvd_l[1+1]*(1-p_acvd_cvdth[1+1])+
                               p_live_cvdth_l[1+1]*p_live_cvd_l[1+1]*p_acvd_cvdth[1+1] +
                               p_live_oth_death[1+1])
a_P["S1", "S2", 6:10]  <- p_live_cvd_l[1+1]*(1-p_acvd_cvdth[1+1])
a_P["S1", "S3", 6:10]  <- p_live_cvdth_l[1+1]*p_live_cvd_l[1+1]*p_acvd_cvdth[1+1]
a_P["S1", "S4", 6:10]  <- p_live_oth_death[1+1]
a_P["S2", "S1", 6:10] <- 0
a_P["S2", "S2", 6:10] <- 1-p_live_oth_death[1+1]-
  (p_ccvd_cvdth[1+1]+p_ccvd_acvd[1+1]*p_acvd_cvdth[1+1])
a_P["S2", "S3", 6:10] <- p_ccvd_cvdth[1+1]+p_ccvd_acvd[1+1]*p_acvd_cvdth[1+1]
a_P["S2", "S4", 6:10] <-  p_live_oth_death[1+1]
a_P["S3", "S3", 6:10] <- 1
a_P["S4", "S4", 6:10] <- 1
a_P
## Initial state vector: All starting healthy
v_s_init <- c(state0 = 1, state1 = 0, state2 = 0, state3 = 0) 
## Initialize cohort trace for Markov model 
m_M <- matrix(0,nrow     = (n_t+1), ncol = n_states, 
              dimnames = list(0:(n_t), v_names_states))
m_M[1, ] <- v_s_init
for(t in 1:10){
  m_M[t + 1, ]      <- m_M[t, ]      %*% a_P[, , t]   
}
m_M
```

\textcolor{red}{This matrix is the trace matrix of the specific population (male, 40-45) during these 10 cycles under Strategy1. The whole cohort starts in $S1$ state and transitions to the rest of the states over time.}

```{r}
CVD_prevented_l <- sum(m_M[,1]*p_live_cvd_l[1])
CVD_prevented_l
```

```{r echo=FALSE}
###################### Construct state-transition models for Strategy1 #####################
#### Create transition arrays ####
a_P <- array(0, dim      = c(n_states, n_states, 10),
                dimnames = list(v_names_states, v_names_states, 1:10))
## From S1, S2, S3, S4
a_P["S1", "S1", 1:5]   <- 1-(p_live_cvd_m[1]*(1-p_acvd_cvdth[1]) +
                               p_live_cvdth_m[1]*p_live_cvd_m[1]*p_acvd_cvdth[1] +
                               p_live_oth_death[1])

a_P["S1", "S2", 1:5]  <- p_live_cvd_m[1]*(1-p_acvd_cvdth[1])
a_P["S1", "S3", 1:5]   <- p_live_cvdth_m[1]*p_live_cvd_m[1]*p_acvd_cvdth[1]
a_P["S1", "S4", 1:5]   <- p_live_oth_death[1]
a_P["S2", "S1", 1:5] <- 0
a_P["S2", "S2", 1:5] <- 1-p_live_oth_death[1]-
  (p_ccvd_cvdth[1]+p_ccvd_acvd[1]*p_acvd_cvdth[1])
a_P["S2", "S3", 1:5] <- p_ccvd_cvdth[1]+
  p_ccvd_acvd[1]*p_acvd_cvdth[1]
a_P["S2", "S4", 1:5] <- p_live_oth_death[1]
a_P["S3", "S3", 1:5] <- 1
a_P["S4", "S4", 1:5] <- 1

## From S1, S2, S3, S4
a_P["S1", "S1", 6:10] <-  1-(p_live_cvd_m[1+1]*(1-p_acvd_cvdth[1+1])+
                               p_live_cvdth_m[1+1]*p_live_cvd_m[1+1]*p_acvd_cvdth[1+1] +
                               p_live_oth_death[1+1])
a_P["S1", "S2", 6:10]  <- p_live_cvd_m[1+1]*(1-p_acvd_cvdth[1+1])
a_P["S1", "S3", 6:10]  <- p_live_cvdth_m[1+1]*p_live_cvd_m[1+1]*p_acvd_cvdth[1+1]
a_P["S1", "S4", 6:10]  <- p_live_oth_death[1+1]
a_P["S2", "S1", 6:10] <- 0
a_P["S2", "S2", 6:10] <- 1-p_live_oth_death[1+1]-
  (p_ccvd_cvdth[1+1]+p_ccvd_acvd[1+1]*p_acvd_cvdth[1+1])
a_P["S2", "S3", 6:10] <- p_ccvd_cvdth[1+1]+p_ccvd_acvd[1+1]*p_acvd_cvdth[1+1]
a_P["S2", "S4", 6:10] <-  p_live_oth_death[1+1]
a_P["S3", "S3", 6:10] <- 1
a_P["S4", "S4", 6:10] <- 1
## Initial state vector: All starting healthy
v_s_init <- c(state0 = 1, state1 = 0, state2 = 0, state3 = 0) 
## Initialize cohort trace for Markov model 
m_M <- matrix(0,nrow     = (n_t+1), ncol = n_states, 
              dimnames = list(0:(n_t), v_names_states))
m_M[1, ] <- v_s_init
for(t in 1:10){
  m_M[t + 1, ]      <- m_M[t, ]      %*% a_P[, , t]   
}
m_M

```

```{r}
CVD_prevented_m <- sum(m_M[,1]*p_live_cvd_m[1])
CVD_prevented_m
```

```{r echo=FALSE}
###################### Construct state-transition models for Strategy1 #####################
#### Create transition arrays ####
a_P <- array(0, dim      = c(n_states, n_states, 10),
                dimnames = list(v_names_states, v_names_states, 1:10))
## From S1, S2, S3, S4
a_P["S1", "S1", 1:5]   <- 1-(p_live_cvd_h[1]*(1-p_acvd_cvdth[1]) +
                               p_live_cvdth_h[1]*p_live_cvd_h[1]*p_acvd_cvdth[1] +
                               p_live_oth_death[1])

a_P["S1", "S2", 1:5]  <- p_live_cvd_h[1]*(1-p_acvd_cvdth[1])
a_P["S1", "S3", 1:5]   <- p_live_cvdth_h[1]*p_live_cvd_h[1]*p_acvd_cvdth[1]
a_P["S1", "S4", 1:5]   <- p_live_oth_death[1]
a_P["S2", "S1", 1:5] <- 0
a_P["S2", "S2", 1:5] <- 1-p_live_oth_death[1]-
  (p_ccvd_cvdth[1]+p_ccvd_acvd[1]*p_acvd_cvdth[1])
a_P["S2", "S3", 1:5] <- p_ccvd_cvdth[1]+
  p_ccvd_acvd[1]*p_acvd_cvdth[1]
a_P["S2", "S4", 1:5] <- p_live_oth_death[1]
a_P["S3", "S3", 1:5] <- 1
a_P["S4", "S4", 1:5] <- 1

## From S1, S2, S3, S4
a_P["S1", "S1", 6:10] <-  1-(p_live_cvd_h[1+1]*(1-p_acvd_cvdth[1+1])+
                               p_live_cvdth_h[1+1]*p_live_cvd_h[1+1]*p_acvd_cvdth[1+1] +
                               p_live_oth_death[1+1])
a_P["S1", "S2", 6:10]  <- p_live_cvd_h[1+1]*(1-p_acvd_cvdth[1+1])
a_P["S1", "S3", 6:10]  <- p_live_cvdth_h[1+1]*p_live_cvd_h[1+1]*p_acvd_cvdth[1+1]
a_P["S1", "S4", 6:10]  <- p_live_oth_death[1+1]
a_P["S2", "S1", 6:10] <- 0
a_P["S2", "S2", 6:10] <- 1-p_live_oth_death[1+1]-
  (p_ccvd_cvdth[1+1]+p_ccvd_acvd[1+1]*p_acvd_cvdth[1+1])
a_P["S2", "S3", 6:10] <- p_ccvd_cvdth[1+1]+p_ccvd_acvd[1+1]*p_acvd_cvdth[1+1]
a_P["S2", "S4", 6:10] <-  p_live_oth_death[1+1]
a_P["S3", "S3", 6:10] <- 1
a_P["S4", "S4", 6:10] <- 1
## Initial state vector: All starting healthy
v_s_init <- c(state0 = 1, state1 = 0, state2 = 0, state3 = 0) 
## Initialize cohort trace for Markov model 
m_M <- matrix(0,nrow     = (n_t+1), ncol = n_states, 
              dimnames = list(0:(n_t), v_names_states))
m_M[1, ] <- v_s_init
for(t in 1:10){
  m_M[t + 1, ]      <- m_M[t, ]      %*% a_P[, , t]   
}
m_M
```

```{r}
CVD_prevented_h <- sum(m_M[,1]*p_live_cvd_h[1])
CVD_prevented_h
```

\textcolor{red}{We perform the same procedure for all risk levels under Strategy1: low, medium and high, and then obtain the following tables for the probability of transitioning from S1 to S2.}

\begin{table}[htbp]
\centering
 \caption{prevented CVD (a male patient aged 40-45)}
\begin{tabular}{ cc } 
\hline
Stratification & CVD events \\
\hline
Low risk & `r CVD_prevented_l`\\
Medium risk & `r CVD_prevented_m`\\
High risk & `r CVD_prevented_h`\\
\hline
\end{tabular}
\end{table}

\newpage

# Prevented CVD events under Strategy1 
```{r}
CVD_prevented_h <- matrix(NA,nrow=14,ncol=1)
# i specify the group of male patients (age)
for(i in 1:6){
  a_P <- array(0, dim      = c(n_states, n_states, 10),
                dimnames = list(v_names_states, v_names_states, 1:10))
## From S1, S2, S3, S4
a_P["S1", "S1", 1:5]   <- 1-(p_live_cvd_h[i]*(1-p_acvd_cvdth[i]) +
                               p_live_cvdth_h[i]*p_live_cvd_h[i]*p_acvd_cvdth[i] +
                               p_live_oth_death[i])

a_P["S1", "S2", 1:5]  <- p_live_cvd_h[i]*(1-p_acvd_cvdth[i])
a_P["S1", "S3", 1:5]   <- p_live_cvdth_h[i]*p_live_cvd_h[i]*p_acvd_cvdth[i]
a_P["S1", "S4", 1:5]   <- p_live_oth_death[i]
a_P["S2", "S1", 1:5] <- 0
a_P["S2", "S2", 1:5] <- 1-p_live_oth_death[i]-
  (p_ccvd_cvdth[i]+p_ccvd_acvd[i]*p_acvd_cvdth[i])
a_P["S2", "S3", 1:5] <- p_ccvd_cvdth[i]+
  p_ccvd_acvd[i]*p_acvd_cvdth[i]
a_P["S2", "S4", 1:5] <- p_live_oth_death[i]
a_P["S3", "S3", 1:5] <- 1
a_P["S4", "S4", 1:5] <- 1

## From S1, S2, S3, S4
a_P["S1", "S1", 6:10] <-  1-(p_live_cvd_h[i+1]*(1-p_acvd_cvdth[i+1])+
                               p_live_cvdth_h[i+1]*p_live_cvd_h[i+1]*p_acvd_cvdth[i+1] +
                               p_live_oth_death[i+1])
a_P["S1", "S2", 6:10]  <- p_live_cvd_h[i+1]*(1-p_acvd_cvdth[i+1])
a_P["S1", "S3", 6:10]  <- p_live_cvdth_h[i+1]*p_live_cvd_h[i+1]*p_acvd_cvdth[i+1]
a_P["S1", "S4", 6:10]  <- p_live_oth_death[i+1]
a_P["S2", "S1", 6:10] <- 0
a_P["S2", "S2", 6:10] <- 1-p_live_oth_death[i+1]-
  (p_ccvd_cvdth[i+1]+p_ccvd_acvd[i+1]*p_acvd_cvdth[i+1])
a_P["S2", "S3", 6:10] <- p_ccvd_cvdth[i+1]+p_ccvd_acvd[i+1]*p_acvd_cvdth[i+1]
a_P["S2", "S4", 6:10] <-  p_live_oth_death[i+1]
a_P["S3", "S3", 6:10] <- 1
a_P["S4", "S4", 6:10] <- 1
## Initial state vector: All starting healthy
v_s_init <- c(state0 = 1, state1 = 0, state2 = 0, state3 = 0) 
## Initialize cohort trace for Markov model 
m_M <- matrix(0,nrow     = (n_t+1), ncol = n_states, 
              dimnames = list(0:(n_t), v_names_states))
m_M[1, ] <- v_s_init
for(t in 1:10){
  m_M[t + 1, ]      <- m_M[t, ]      %*% a_P[, , t]   
}
m_M
CVD_prevented_h[i] <- sum(m_M[,1]*p_live_cvd_h[i])
}

# the group of the male patients aged 70-75
a_P <- array(0, dim      = c(n_states, n_states, 10),
                dimnames = list(v_names_states, v_names_states, 1:10))
## From S1, S2, S3, S4
a_P["S1", "S1", 1:10]   <- 1-(p_live_cvd_h[7]*(1-p_acvd_cvdth[7]) +
                               p_live_cvdth_h[7]*p_live_cvd_h[7]*p_acvd_cvdth[7] +
                               p_live_oth_death[7])

a_P["S1", "S2", 1:10]  <- p_live_cvd_h[7]*(1-p_acvd_cvdth[7])
a_P["S1", "S3", 1:10]   <- p_live_cvdth_h[7]*p_live_cvd_h[7]*p_acvd_cvdth[7]
a_P["S1", "S4", 1:10]   <- p_live_oth_death[7]
a_P["S2", "S1", 1:10] <- 0
a_P["S2", "S2", 1:10] <- 1-p_live_oth_death[7]-
  (p_ccvd_cvdth[7]+p_ccvd_acvd[7]*p_acvd_cvdth[7])
a_P["S2", "S3", 1:10] <- p_ccvd_cvdth[7]+
  p_ccvd_acvd[7]*p_acvd_cvdth[7]
a_P["S2", "S4", 1:10] <- p_live_oth_death[7]
a_P["S3", "S3", 1:10] <- 1
a_P["S4", "S4", 1:10] <- 1

## Initial state vector: All starting healthy
v_s_init <- c(state0 = 1, state1 = 0, state2 = 0, state3 = 0) 
## Initialize cohort trace for Markov model 
m_M <- matrix(0,nrow     = (n_t+1), ncol = n_states, 
              dimnames = list(0:(n_t), v_names_states))
m_M[1, ] <- v_s_init
for(t in 1:10){
  m_M[t + 1, ]      <- m_M[t, ]      %*% a_P[, , t]   
}

CVD_prevented_h[7] <- sum(m_M[,1]*p_live_cvd_h[7])
#-----------------------------------------------------------------------------------
# i specify the group of female patients (age)
for(i in 8:13){  
  a_P <- array(0, dim      = c(n_states, n_states, 10),
                dimnames = list(v_names_states, v_names_states, 1:10))
## From S1, S2, S3, S4
a_P["S1", "S1", 1:5]   <- 1-(p_live_cvd_h[i]*(1-p_acvd_cvdth[i]) +
                               p_live_cvdth_h[i]*p_live_cvd_h[i]*p_acvd_cvdth[i] +
                               p_live_oth_death[i])

a_P["S1", "S2", 1:5]  <- p_live_cvd_h[i]*(1-p_acvd_cvdth[i])
a_P["S1", "S3", 1:5]   <- p_live_cvdth_h[i]*p_live_cvd_h[i]*p_acvd_cvdth[i]
a_P["S1", "S4", 1:5]   <- p_live_oth_death[i]
a_P["S2", "S1", 1:5] <- 0
a_P["S2", "S2", 1:5] <- 1-p_live_oth_death[i]-
  (p_ccvd_cvdth[i]+p_ccvd_acvd[i]*p_acvd_cvdth[i])
a_P["S2", "S3", 1:5] <- p_ccvd_cvdth[i]+
  p_ccvd_acvd[i]*p_acvd_cvdth[i]
a_P["S2", "S4", 1:5] <- p_live_oth_death[i]
a_P["S3", "S3", 1:5] <- 1
a_P["S4", "S4", 1:5] <- 1

## From S1, S2, S3, S4
a_P["S1", "S1", 6:10] <-  1-(p_live_cvd_h[i+1]*(1-p_acvd_cvdth[i+1])+
                               p_live_cvdth_h[i+1]*p_live_cvd_h[i+1]*p_acvd_cvdth[i+1] +
                               p_live_oth_death[i+1])
a_P["S1", "S2", 6:10]  <- p_live_cvd_h[i+1]*(1-p_acvd_cvdth[i+1])
a_P["S1", "S3", 6:10]  <- p_live_cvdth_h[i+1]*p_live_cvd_h[i+1]*p_acvd_cvdth[i+1]
a_P["S1", "S4", 6:10]  <- p_live_oth_death[i+1]
a_P["S2", "S1", 6:10] <- 0
a_P["S2", "S2", 6:10] <- 1-p_live_oth_death[i+1]-
  (p_ccvd_cvdth[i+1]+p_ccvd_acvd[i+1]*p_acvd_cvdth[i+1])
a_P["S2", "S3", 6:10] <- p_ccvd_cvdth[i+1]+p_ccvd_acvd[i+1]*p_acvd_cvdth[i+1]
a_P["S2", "S4", 6:10] <-  p_live_oth_death[i+1]
a_P["S3", "S3", 6:10] <- 1
a_P["S4", "S4", 6:10] <- 1
## Initial state vector: All starting healthy
v_s_init <- c(state0 = 1, state1 = 0, state2 = 0, state3 = 0) 
## Initialize cohort trace for Markov model 
m_M <- matrix(0,nrow     = (n_t+1), ncol = n_states, 
              dimnames = list(0:(n_t), v_names_states))
m_M[1, ] <- v_s_init
for(t in 1:10){
  m_M[t + 1, ]      <- m_M[t, ]      %*% a_P[, , t]   
}
CVD_prevented_h[i] <- sum(m_M[,1]*p_live_cvd_h[i])
}

a_P <- array(0, dim      = c(n_states, n_states, 10),
                dimnames = list(v_names_states, v_names_states, 1:10))
a_P["S1", "S1", 1:10]   <- 1-(p_live_cvd_h[7]*(1-p_acvd_cvdth[7]) +
                               p_live_cvdth_h[7]*p_live_cvd_h[7]*p_acvd_cvdth[7] +
                               p_live_oth_death[7])

a_P["S1", "S2", 1:10]  <- p_live_cvd_h[7]*(1-p_acvd_cvdth[7])
a_P["S1", "S3", 1:10]   <- p_live_cvdth_h[7]*p_live_cvd_h[7]*p_acvd_cvdth[7]
a_P["S1", "S4", 1:10]   <- p_live_oth_death[7]
a_P["S2", "S1", 1:10] <- 0
a_P["S2", "S2", 1:10] <- 1-p_live_oth_death[7]-
  (p_ccvd_cvdth[7]+p_ccvd_acvd[7]*p_acvd_cvdth[7])
a_P["S2", "S3", 1:10] <- p_ccvd_cvdth[7]+
  p_ccvd_acvd[7]*p_acvd_cvdth[7]
a_P["S2", "S4", 1:10] <- p_live_oth_death[7]
a_P["S3", "S3", 1:10] <- 1
a_P["S4", "S4", 1:10] <- 1

## Initial state vector: All starting healthy
v_s_init <- c(state0 = 1, state1 = 0, state2 = 0, state3 = 0) 
## Initialize cohort trace for Markov model 
m_M <- matrix(0,nrow     = (n_t+1), ncol = n_states, 
              dimnames = list(0:(n_t), v_names_states))
m_M[1, ] <- v_s_init
for(t in 1:10){
  m_M[t + 1, ]      <- m_M[t, ]      %*% a_P[, , t]   
}
CVD_prevented_h[14] <- sum(m_M[,1]*p_live_cvd_h[14])
```

```{r}
CVD_prevented_m <- matrix(NA,nrow=14,ncol=1)
# i specify the group of male patients (age)
for(i in 1:6){
  a_P <- array(0, dim      = c(n_states, n_states, 10),
                dimnames = list(v_names_states, v_names_states, 1:10))
## From S1, S2, S3, S4
a_P["S1", "S1", 1:5]   <- 1-(p_live_cvd_m[i]*(1-p_acvd_cvdth[i]) +
                               p_live_cvdth_m[i]*p_live_cvd_m[i]*p_acvd_cvdth[i] +
                               p_live_oth_death[i])

a_P["S1", "S2", 1:5]  <- p_live_cvd_m[i]*(1-p_acvd_cvdth[i])
a_P["S1", "S3", 1:5]   <- p_live_cvdth_m[i]*p_live_cvd_m[i]*p_acvd_cvdth[i]
a_P["S1", "S4", 1:5]   <- p_live_oth_death[i]
a_P["S2", "S1", 1:5] <- 0
a_P["S2", "S2", 1:5] <- 1-p_live_oth_death[i]-
  (p_ccvd_cvdth[i]+p_ccvd_acvd[i]*p_acvd_cvdth[i])
a_P["S2", "S3", 1:5] <- p_ccvd_cvdth[i]+
  p_ccvd_acvd[i]*p_acvd_cvdth[i]
a_P["S2", "S4", 1:5] <- p_live_oth_death[i]
a_P["S3", "S3", 1:5] <- 1
a_P["S4", "S4", 1:5] <- 1

## From S1, S2, S3, S4
a_P["S1", "S1", 6:10] <-  1-(p_live_cvd_m[i+1]*(1-p_acvd_cvdth[i+1])+
                               p_live_cvdth_m[i+1]*p_live_cvd_m[i+1]*p_acvd_cvdth[i+1] +
                               p_live_oth_death[i+1])
a_P["S1", "S2", 6:10]  <- p_live_cvd_m[i+1]*(1-p_acvd_cvdth[i+1])
a_P["S1", "S3", 6:10]  <- p_live_cvdth_m[i+1]*p_live_cvd_m[i+1]*p_acvd_cvdth[i+1]
a_P["S1", "S4", 6:10]  <- p_live_oth_death[i+1]
a_P["S2", "S1", 6:10] <- 0
a_P["S2", "S2", 6:10] <- 1-p_live_oth_death[i+1]-
  (p_ccvd_cvdth[i+1]+p_ccvd_acvd[i+1]*p_acvd_cvdth[i+1])
a_P["S2", "S3", 6:10] <- p_ccvd_cvdth[i+1]+p_ccvd_acvd[i+1]*p_acvd_cvdth[i+1]
a_P["S2", "S4", 6:10] <-  p_live_oth_death[i+1]
a_P["S3", "S3", 6:10] <- 1
a_P["S4", "S4", 6:10] <- 1
## Initial state vector: All starting healthy
v_s_init <- c(state0 = 1, state1 = 0, state2 = 0, state3 = 0) 
## Initialize cohort trace for Markov model 
m_M <- matrix(0,nrow     = (n_t+1), ncol = n_states, 
              dimnames = list(0:(n_t), v_names_states))
m_M[1, ] <- v_s_init
for(t in 1:10){
  m_M[t + 1, ]      <- m_M[t, ]      %*% a_P[, , t]   
}
CVD_prevented_m[i] <- sum(m_M[,1]*p_live_cvd_m[i])
}

# the group of the male patients aged 70-75
a_P <- array(0, dim      = c(n_states, n_states, 10),
                dimnames = list(v_names_states, v_names_states, 1:10))
## From S1, S2, S3, S4
a_P["S1", "S1", 1:10]   <- 1-(p_live_cvd_m[7]*(1-p_acvd_cvdth[7]) +
                               p_live_cvdth_m[7]*p_live_cvd_m[7]*p_acvd_cvdth[7] +
                               p_live_oth_death[7])

a_P["S1", "S2", 1:10]  <- p_live_cvd_m[7]*(1-p_acvd_cvdth[7])
a_P["S1", "S3", 1:10]   <- p_live_cvdth_m[7]*p_live_cvd_m[7]*p_acvd_cvdth[7]
a_P["S1", "S4", 1:10]   <- p_live_oth_death[7]
a_P["S2", "S1", 1:10] <- 0
a_P["S2", "S2", 1:10] <- 1-p_live_oth_death[7]-
  (p_ccvd_cvdth[7]+p_ccvd_acvd[7]*p_acvd_cvdth[7])
a_P["S2", "S3", 1:10] <- p_ccvd_cvdth[7]+
  p_ccvd_acvd[7]*p_acvd_cvdth[7]
a_P["S2", "S4", 1:10] <- p_live_oth_death[7]
a_P["S3", "S3", 1:10] <- 1
a_P["S4", "S4", 1:10] <- 1

## Initial state vector: All starting healthy
v_s_init <- c(state0 = 1, state1 = 0, state2 = 0, state3 = 0) 
## Initialize cohort trace for Markov model 
m_M <- matrix(0,nrow     = (n_t+1), ncol = n_states, 
              dimnames = list(0:(n_t), v_names_states))
m_M[1, ] <- v_s_init
for(t in 1:10){
  m_M[t + 1, ]      <- m_M[t, ]      %*% a_P[, , t]   
}
CVD_prevented_m[7] <- sum(m_M[,1]*p_live_cvd_m[7])

#-----------------------------------------------------------------------------------
# i specify the group of female patients (age)
for(i in 8:13){  
  a_P <- array(0, dim      = c(n_states, n_states, 10),
                dimnames = list(v_names_states, v_names_states, 1:10))
## From S1, S2, S3, S4
a_P["S1", "S1", 1:5]   <- 1-(p_live_cvd_m[i]*(1-p_acvd_cvdth[i]) +
                               p_live_cvdth_m[i]*p_live_cvd_m[i]*p_acvd_cvdth[i] +
                               p_live_oth_death[i])

a_P["S1", "S2", 1:5]  <- p_live_cvd_m[i]*(1-p_acvd_cvdth[i])
a_P["S1", "S3", 1:5]   <- p_live_cvdth_m[i]*p_live_cvd_m[i]*p_acvd_cvdth[i]
a_P["S1", "S4", 1:5]   <- p_live_oth_death[i]
a_P["S2", "S1", 1:5] <- 0
a_P["S2", "S2", 1:5] <- 1-p_live_oth_death[i]-
  (p_ccvd_cvdth[i]+p_ccvd_acvd[i]*p_acvd_cvdth[i])
a_P["S2", "S3", 1:5] <- p_ccvd_cvdth[i]+
  p_ccvd_acvd[i]*p_acvd_cvdth[i]
a_P["S2", "S4", 1:5] <- p_live_oth_death[i]
a_P["S3", "S3", 1:5] <- 1
a_P["S4", "S4", 1:5] <- 1

## From S1, S2, S3, S4
a_P["S1", "S1", 6:10] <-  1-(p_live_cvd_m[i+1]*(1-p_acvd_cvdth[i+1])+
                               p_live_cvdth_m[i+1]*p_live_cvd_m[i+1]*p_acvd_cvdth[i+1] +
                               p_live_oth_death[i+1])
a_P["S1", "S2", 6:10]  <- p_live_cvd_m[i+1]*(1-p_acvd_cvdth[i+1])
a_P["S1", "S3", 6:10]  <- p_live_cvdth_m[i+1]*p_live_cvd_m[i+1]*p_acvd_cvdth[i+1]
a_P["S1", "S4", 6:10]  <- p_live_oth_death[i+1]
a_P["S2", "S1", 6:10] <- 0
a_P["S2", "S2", 6:10] <- 1-p_live_oth_death[i+1]-
  (p_ccvd_cvdth[i+1]+p_ccvd_acvd[i+1]*p_acvd_cvdth[i+1])
a_P["S2", "S3", 6:10] <- p_ccvd_cvdth[i+1]+p_ccvd_acvd[i+1]*p_acvd_cvdth[i+1]
a_P["S2", "S4", 6:10] <-  p_live_oth_death[i+1]
a_P["S3", "S3", 6:10] <- 1
a_P["S4", "S4", 6:10] <- 1
## Initial state vector: All starting healthy
v_s_init <- c(state0 = 1, state1 = 0, state2 = 0, state3 = 0) 
## Initialize cohort trace for Markov model 
m_M <- matrix(0,nrow     = (n_t+1), ncol = n_states, 
              dimnames = list(0:(n_t), v_names_states))
m_M[1, ] <- v_s_init
for(t in 1:10){
  m_M[t + 1, ]      <- m_M[t, ]      %*% a_P[, , t]   
}
CVD_prevented_m[i] <- sum(m_M[,1]*p_live_cvd_m[i])
}

a_P <- array(0, dim      = c(n_states, n_states, 10),
                dimnames = list(v_names_states, v_names_states, 1:10))
a_P["S1", "S1", 1:10]   <- 1-(p_live_cvd_m[7]*(1-p_acvd_cvdth[7]) +
                               p_live_cvdth_m[7]*p_live_cvd_m[7]*p_acvd_cvdth[7] +
                               p_live_oth_death[7])

a_P["S1", "S2", 1:10]  <- p_live_cvd_m[7]*(1-p_acvd_cvdth[7])
a_P["S1", "S3", 1:10]   <- p_live_cvdth_m[7]*p_live_cvd_m[7]*p_acvd_cvdth[7]
a_P["S1", "S4", 1:10]   <- p_live_oth_death[7]
a_P["S2", "S1", 1:10] <- 0
a_P["S2", "S2", 1:10] <- 1-p_live_oth_death[7]-
  (p_ccvd_cvdth[7]+p_ccvd_acvd[7]*p_acvd_cvdth[7])
a_P["S2", "S3", 1:10] <- p_ccvd_cvdth[7]+
  p_ccvd_acvd[7]*p_acvd_cvdth[7]
a_P["S2", "S4", 1:10] <- p_live_oth_death[7]
a_P["S3", "S3", 1:10] <- 1
a_P["S4", "S4", 1:10] <- 1

## Initial state vector: All starting healthy
v_s_init <- c(state0 = 1, state1 = 0, state2 = 0, state3 = 0) 
## Initialize cohort trace for Markov model 
m_M <- matrix(0,nrow     = (n_t+1), ncol = n_states, 
              dimnames = list(0:(n_t), v_names_states))
m_M[1, ] <- v_s_init
for(t in 1:10){
  m_M[t + 1, ]      <- m_M[t, ]      %*% a_P[, , t]   
}
CVD_prevented_m[14] <- sum(m_M[,1]*p_live_cvd_m[14])
```

```{r}
CVD_prevented_l <- matrix(NA,nrow=14,ncol=1)

# i specify the group of male patients (age)
for(i in 1:6){
  a_P <- array(0, dim      = c(n_states, n_states, 10),
                dimnames = list(v_names_states, v_names_states, 1:10))
## From S1, S2, S3, S4
a_P["S1", "S1", 1:5]   <- 1-(p_live_cvd_l[i]*(1-p_acvd_cvdth[i]) +
                               p_live_cvdth_l[i]*p_live_cvd_l[i]*p_acvd_cvdth[i] +
                               p_live_oth_death[i])

a_P["S1", "S2", 1:5]  <- p_live_cvd_l[i]*(1-p_acvd_cvdth[i])
a_P["S1", "S3", 1:5]   <- p_live_cvdth_l[i]*p_live_cvd_l[i]*p_acvd_cvdth[i]
a_P["S1", "S4", 1:5]   <- p_live_oth_death[i]
a_P["S2", "S1", 1:5] <- 0
a_P["S2", "S2", 1:5] <- 1-p_live_oth_death[i]-
  (p_ccvd_cvdth[i]+p_ccvd_acvd[i]*p_acvd_cvdth[i])
a_P["S2", "S3", 1:5] <- p_ccvd_cvdth[i]+
  p_ccvd_acvd[i]*p_acvd_cvdth[i]
a_P["S2", "S4", 1:5] <- p_live_oth_death[i]
a_P["S3", "S3", 1:5] <- 1
a_P["S4", "S4", 1:5] <- 1

## From S1, S2, S3, S4
a_P["S1", "S1", 6:10] <-  1-(p_live_cvd_l[i+1]*(1-p_acvd_cvdth[i+1])+
                               p_live_cvdth_l[i+1]*p_live_cvd_l[i+1]*p_acvd_cvdth[i+1] +
                               p_live_oth_death[i+1])
a_P["S1", "S2", 6:10]  <- p_live_cvd_l[i+1]*(1-p_acvd_cvdth[i+1])
a_P["S1", "S3", 6:10]  <- p_live_cvdth_l[i+1]*p_live_cvd_l[i+1]*p_acvd_cvdth[i+1]
a_P["S1", "S4", 6:10]  <- p_live_oth_death[i+1]
a_P["S2", "S1", 6:10] <- 0
a_P["S2", "S2", 6:10] <- 1-p_live_oth_death[i+1]-
  (p_ccvd_cvdth[i+1]+p_ccvd_acvd[i+1]*p_acvd_cvdth[i+1])
a_P["S2", "S3", 6:10] <- p_ccvd_cvdth[i+1]+p_ccvd_acvd[i+1]*p_acvd_cvdth[i+1]
a_P["S2", "S4", 6:10] <-  p_live_oth_death[i+1]
a_P["S3", "S3", 6:10] <- 1
a_P["S4", "S4", 6:10] <- 1
## Initial state vector: All starting healthy
v_s_init <- c(state0 = 1, state1 = 0, state2 = 0, state3 = 0) 
## Initialize cohort trace for Markov model 
m_M <- matrix(0,nrow     = (n_t+1), ncol = n_states, 
              dimnames = list(0:(n_t), v_names_states))
m_M[1, ] <- v_s_init
for(t in 1:10){
  m_M[t + 1, ]      <- m_M[t, ]      %*% a_P[, , t]   
}
CVD_prevented_l[i] <- sum(m_M[,1]*p_live_cvd_l[i])

}

# the group of the male patients aged 70-75
a_P <- array(0, dim      = c(n_states, n_states, 10),
                dimnames = list(v_names_states, v_names_states, 1:10))
## From S1, S2, S3, S4
a_P["S1", "S1", 1:10]   <- 1-(p_live_cvd_l[7]*(1-p_acvd_cvdth[7]) +
                               p_live_cvdth_l[7]*p_live_cvd_l[7]*p_acvd_cvdth[7] +
                               p_live_oth_death[7])

a_P["S1", "S2", 1:10]  <- p_live_cvd_l[7]*(1-p_acvd_cvdth[7])
a_P["S1", "S3", 1:10]   <- p_live_cvdth_l[7]*p_live_cvd_l[7]*p_acvd_cvdth[7]
a_P["S1", "S4", 1:10]   <- p_live_oth_death[7]
a_P["S2", "S1", 1:10] <- 0
a_P["S2", "S2", 1:10] <- 1-p_live_oth_death[7]-
  (p_ccvd_cvdth[7]+p_ccvd_acvd[7]*p_acvd_cvdth[7])
a_P["S2", "S3", 1:10] <- p_ccvd_cvdth[7]+
  p_ccvd_acvd[7]*p_acvd_cvdth[7]
a_P["S2", "S4", 1:10] <- p_live_oth_death[7]
a_P["S3", "S3", 1:10] <- 1
a_P["S4", "S4", 1:10] <- 1

## Initial state vector: All starting healthy
v_s_init <- c(state0 = 1, state1 = 0, state2 = 0, state3 = 0) 
## Initialize cohort trace for Markov model 
m_M <- matrix(0,nrow     = (n_t+1), ncol = n_states, 
              dimnames = list(0:(n_t), v_names_states))
m_M[1, ] <- v_s_init
for(t in 1:10){
  m_M[t + 1, ]      <- m_M[t, ]      %*% a_P[, , t]   
}
CVD_prevented_l[7] <- sum(m_M[,1]*p_live_cvd_l[7])

#-----------------------------------------------------------------------------------
# i specify the group of female patients (age)
for(i in 8:13){  
  a_P <- array(0, dim      = c(n_states, n_states, 10),
                dimnames = list(v_names_states, v_names_states, 1:10))
## From S1, S2, S3, S4
a_P["S1", "S1", 1:5]   <- 1-(p_live_cvd_l[i]*(1-p_acvd_cvdth[i]) +
                               p_live_cvdth_l[i]*p_live_cvd_l[i]*p_acvd_cvdth[i] +
                               p_live_oth_death[i])

a_P["S1", "S2", 1:5]  <- p_live_cvd_l[i]*(1-p_acvd_cvdth[i])
a_P["S1", "S3", 1:5]   <- p_live_cvdth_l[i]*p_live_cvd_l[i]*p_acvd_cvdth[i]
a_P["S1", "S4", 1:5]   <- p_live_oth_death[i]
a_P["S2", "S1", 1:5] <- 0
a_P["S2", "S2", 1:5] <- 1-p_live_oth_death[i]-
  (p_ccvd_cvdth[i]+p_ccvd_acvd[i]*p_acvd_cvdth[i])
a_P["S2", "S3", 1:5] <- p_ccvd_cvdth[i]+
  p_ccvd_acvd[i]*p_acvd_cvdth[i]
a_P["S2", "S4", 1:5] <- p_live_oth_death[i]
a_P["S3", "S3", 1:5] <- 1
a_P["S4", "S4", 1:5] <- 1

## From S1, S2, S3, S4
a_P["S1", "S1", 6:10] <-  1-(p_live_cvd_l[i+1]*(1-p_acvd_cvdth[i+1])+
                               p_live_cvdth_l[i+1]*p_live_cvd_l[i+1]*p_acvd_cvdth[i+1] +
                               p_live_oth_death[i+1])
a_P["S1", "S2", 6:10]  <- p_live_cvd_l[i+1]*(1-p_acvd_cvdth[i+1])
a_P["S1", "S3", 6:10]  <- p_live_cvdth_l[i+1]*p_live_cvd_l[i+1]*p_acvd_cvdth[i+1]
a_P["S1", "S4", 6:10]  <- p_live_oth_death[i+1]
a_P["S2", "S1", 6:10] <- 0
a_P["S2", "S2", 6:10] <- 1-p_live_oth_death[i+1]-
  (p_ccvd_cvdth[i+1]+p_ccvd_acvd[i+1]*p_acvd_cvdth[i+1])
a_P["S2", "S3", 6:10] <- p_ccvd_cvdth[i+1]+p_ccvd_acvd[i+1]*p_acvd_cvdth[i+1]
a_P["S2", "S4", 6:10] <-  p_live_oth_death[i+1]
a_P["S3", "S3", 6:10] <- 1
a_P["S4", "S4", 6:10] <- 1
## Initial state vector: All starting healthy
v_s_init <- c(state0 = 1, state1 = 0, state2 = 0, state3 = 0) 
## Initialize cohort trace for Markov model 
m_M <- matrix(0,nrow     = (n_t+1), ncol = n_states, 
              dimnames = list(0:(n_t), v_names_states))
m_M[1, ] <- v_s_init
for(t in 1:10){
  m_M[t + 1, ]      <- m_M[t, ]      %*% a_P[, , t]   
}
CVD_prevented_l[i] <- sum(m_M[,1]*p_live_cvd_l[i])

}

a_P <- array(0, dim      = c(n_states, n_states, 10),
                dimnames = list(v_names_states, v_names_states, 1:10))
a_P["S1", "S1", 1:10]   <- 1-(p_live_cvd_l[7]*(1-p_acvd_cvdth[7]) +
                               p_live_cvdth_l[7]*p_live_cvd_l[7]*p_acvd_cvdth[7] +
                               p_live_oth_death[7])

a_P["S1", "S2", 1:10]  <- p_live_cvd_l[7]*(1-p_acvd_cvdth[7])
a_P["S1", "S3", 1:10]   <- p_live_cvdth_l[7]*p_live_cvd_l[7]*p_acvd_cvdth[7]
a_P["S1", "S4", 1:10]   <- p_live_oth_death[7]
a_P["S2", "S1", 1:10] <- 0
a_P["S2", "S2", 1:10] <- 1-p_live_oth_death[7]-
  (p_ccvd_cvdth[7]+p_ccvd_acvd[7]*p_acvd_cvdth[7])
a_P["S2", "S3", 1:10] <- p_ccvd_cvdth[7]+
  p_ccvd_acvd[7]*p_acvd_cvdth[7]
a_P["S2", "S4", 1:10] <- p_live_oth_death[7]
a_P["S3", "S3", 1:10] <- 1
a_P["S4", "S4", 1:10] <- 1

## Initial state vector: All starting healthy
v_s_init <- c(state0 = 1, state1 = 0, state2 = 0, state3 = 0) 
## Initialize cohort trace for Markov model 
m_M <- matrix(0,nrow     = (n_t+1), ncol = n_states, 
              dimnames = list(0:(n_t), v_names_states))
m_M[1, ] <- v_s_init
for(t in 1:10){
  m_M[t + 1, ]      <- m_M[t, ]      %*% a_P[, , t]   
}
CVD_prevented_l[14] <- sum(m_M[,1]*p_live_cvd_l[14])
```


```{r results='asis', message=FALSE}
CVD_prevented_l <- as.numeric(CVD_prevented_l)
CVD_prevented_m <- as.numeric(CVD_prevented_m)
CVD_prevented_h <- as.numeric(CVD_prevented_h)

res <- data.frame(cbind("index"=rate_data$index,
                        "sex"=rate_data$sex,
                        "low"=CVD_prevented_l,
                        "medium"=CVD_prevented_m,
                        "high"=CVD_prevented_h
                        ))
print(xtable(res,digits=c(0,0,0,3,3,3),
      caption = "prevented CVD events under the screening of Strategy 1"),
      caption.placement="top")
```


```{r}
population_data_strategy1 <- population_data[which(population_data$strategy=="strategy1"),
                                             c("low","medium","high")]
cvd_dat_strategy1 <- data.frame(cbind(as.numeric(as.character(res$low)),
                            as.numeric(as.character(res$medium)),
                            as.numeric(as.character(res$high))))
result_strategy1 <- sum(population_data_strategy1*cvd_dat_strategy1)
result_strategy1
```


\textcolor{red}{This is the result for the CVD events under 3 different strategies}

